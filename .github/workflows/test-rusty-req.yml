name: Cross-Platform rusty-req Test

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'é€‰æ‹©è¦æµ‹è¯•çš„å¹³å°'
        type: choice
        options:
          - all-platforms
          - linux-only
          - windows-only
          - macos-only
        default: 'all-platforms'
      python-versions:
        description: 'Pythonç‰ˆæœ¬ï¼ˆé€—å·åˆ†éš”ï¼‰'
        default: '3.9,3.10,3.11'

jobs:
  cross-platform-test:
    strategy:
      matrix:
        os:
          ${{
          github.event.inputs.platforms == 'all-platforms' &&
          '["ubuntu-latest", "windows-latest", "macos-latest"]' ||
          github.event.inputs.platforms == 'linux-only' &&
          '["ubuntu-latest"]' ||
          github.event.inputs.platforms == 'windows-only' &&
          '["windows-latest"]' ||
          github.event.inputs.platforms == 'macos-only' &&
          '["macos-latest"]'
          }}
        python-version: ${{ fromJSON(format('[{0}]', join(split(github.event.inputs.python-versions, ','), ',')) }}

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }} on ${{ matrix.os }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Display platform information
        run: |
          echo "=== å¹³å°ä¿¡æ¯ ==="
          echo "æ“ä½œç³»ç»Ÿ: ${{ matrix.os }}"
          python -c "
          import platform
          import sys
          print(f'Pythonç‰ˆæœ¬: {sys.version}')
          print(f'ç³»ç»Ÿå¹³å°: {platform.platform()}')
          print(f'ç³»ç»Ÿç±»å‹: {platform.system()} {platform.release()}')
          print(f'å¤„ç†å™¨: {platform.processor()}')
          "

      - name: Install rusty-req
        run: |
          echo "åœ¨ ${{ matrix.os }} ä¸Šå®‰è£… rusty-req (Python ${{ matrix.python-version }})"
          pip install --upgrade pip
          pip install rusty-req --no-cache-dir

      - name: Verify installation
        run: |
          echo "=== éªŒè¯å®‰è£… ==="
          python -c "
          try:
              import rusty_req
              print('âœ… rusty-req å¯¼å…¥æˆåŠŸ')
              print(f'ç‰ˆæœ¬: {rusty_req.__version__}')
              print(f'æ–‡ä»¶è·¯å¾„: {rusty_req.__file__}')
          
              # å¹³å°ç‰¹å®šçš„éªŒè¯
              import platform
              system = platform.system()
              if system == 'Windows':
                  print('ğŸ¯ è¿™æ˜¯åœ¨ Windows ä¸Šçš„æµ‹è¯•')
              elif system == 'Linux':
                  print('ğŸ§ è¿™æ˜¯åœ¨ Linux ä¸Šçš„æµ‹è¯•')
              elif system == 'Darwin':
                  print 'ğŸ è¿™æ˜¯åœ¨ macOS ä¸Šçš„æµ‹è¯•')
          
          except ImportError as e:
              print(f'âŒ å¯¼å…¥å¤±è´¥: {e}')
              exit(1)
          except Exception as e:
              print(f'âš ï¸  å…¶ä»–é”™è¯¯: {e}')
              exit(1)
          "

      - name: Run platform-specific tests
        run: |
          echo "=== è¿è¡Œå¹³å°ç‰¹å®šæµ‹è¯• ==="
          
          # Windows ç‰¹å®šæµ‹è¯•
          if [[ "${{ matrix.os }}" == *"windows"* ]]; then
            echo "è¿è¡Œ Windows ç‰¹å®šæ£€æŸ¥..."
            python -c "
            import os
            print('Windows è·¯å¾„åˆ†éš”ç¬¦:', repr(os.path.sep))
            "
          fi
          
          # Linux ç‰¹å®šæµ‹è¯•
          if [[ "${{ matrix.os }}" == *"ubuntu"* ]]; then
            echo "è¿è¡Œ Linux ç‰¹å®šæ£€æŸ¥..."
            python -c "
            import os
            print('Linux ç¯å¢ƒå˜é‡:', dict(os.environ))
            "
          fi
          
          # macOS ç‰¹å®šæµ‹è¯•
          if [[ "${{ matrix.os }}" == *"macos"* ]]; then
            echo "è¿è¡Œ macOS ç‰¹å®šæ£€æŸ¥..."
            python -c "
            import platform
            print('macOS ç‰ˆæœ¬:', platform.mac_ver())
            "
          fi